Drop-in fixed version of your function
// netlify/functions/src/handler.js (or wherever your function code lives)
import OpenAI from "openai";
import { baseSystemPrompt } from "./prompt.js";
import { getRelevantSections } from "./retrieval.js";

export const CURRENT_OPENAI_MODEL = "gpt-5-nano";
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export async function getChatbotResponse(userMessage) {
  const context = getRelevantSections(userMessage, { maxSections: 3, maxChars: 2500 });

  try {
    const r = await openai.responses.create({
      model: CURRENT_OPENAI_MODEL,
      input: `System:
${baseSystemPrompt.trim()}

User:
Question:
${userMessage}

CONTEXT:
${context}`,
      // Determinism & verbosity
      temperature: 0.2,
      top_p: 1,
      max_output_tokens: 800
    });

    const answer =
      r.output_text ??
      r.output?.[0]?.content?.[0]?.text ??
      "Aloha â€” I couldn't generate a response. Please try again.";

    return answer;
  } catch (err) {
    // Log the real upstream error so you can see it in Netlify Function logs
    console.error(
      "OpenAI API error:",
      err.status ?? err.response?.status,
      err.message,
      err.response?.data
    );
    // Re-throw so the HTTP wrapper can set a non-200 and the UI shows an error state
    throw err;
  }
}


And make sure your HTTP handler wraps this without swallowing errors:

export const handler = async (event) => {
  const headers = {
    "Access-Control-Allow-Origin": event.headers.origin || "https://yourdomain.com",
    "Access-Control-Allow-Headers": "Content-Type, Authorization",
    "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
    "Content-Type": "application/json"
  };

  if (event.httpMethod === "OPTIONS") return { statusCode: 200, headers, body: "" };
  if (event.httpMethod !== "POST") return { statusCode: 405, headers, body: JSON.stringify({ error: "Method not allowed" }) };

  let body;
  try { body = JSON.parse(event.body); }
  catch { return { statusCode: 400, headers, body: JSON.stringify({ error: "Invalid JSON" }) }; }

  const message = body?.message;
  if (!message || typeof message !== "string") {
    return { statusCode: 400, headers, body: JSON.stringify({ error: "Message is required" }) };
  }

  try {
    const response = await getChatbotResponse(message);
    return { statusCode: 200, headers, body: JSON.stringify({ response }) };
  } catch (err) {
    const code = err.status || err.response?.status || 502;
    return { statusCode: code, headers, body: JSON.stringify({ error: "Upstream model error" }) };
  }
};